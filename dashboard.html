<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Requests - Rolling Translations</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="container">
        <img src="images/logo.png" alt="Rolling Translations Logo" class="logo" />
        <h1>Your Translation Requests</h1>

        <!-- Empty state -->
        <p id="emptyState" style="display:none; margin: 16px 0;">No active requests.</p>

        <!-- Actions -->
        <div style="margin: 12px 0;">
            <button id="newRequestBtn">Submit a new request</button>
        </div>

        <!-- Table -->
        <table id="requestsTable" style="display:none;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Languages</th>
                    <th>File</th>
                    <th>Status</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button id="logoutBtn" style="margin-top:16px;">Log out</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYjq_CaTEfFhfTChfJ6SnXSbgIzbbRHHc",
            authDomain: "rollingtranslationsportal.firebaseapp.com",
            projectId: "rollingtranslationsportal",
            storageBucket: "rollingtranslationsportal.firebasestorage.app",
            messagingSenderId: "492156326175",
            appId: "1:492156326175:web:14175badae2bbaada0e02a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const table = document.getElementById("requestsTable");
        const tableBody = table.querySelector("tbody");
        const emptyState = document.getElementById("emptyState");

        document.getElementById("newRequestBtn").addEventListener("click", () => {
            window.location.href = "submit-request.html";
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            signOut(auth).then(() => (window.location.href = "index.html"));
        });

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }

            try {
                const q = query(
                    collection(db, "projectRequests"),
                    where("email", "==", user.email),
                    orderBy("createdAt", "desc")
                );

                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    // No requests â†’ show empty state, hide table
                    emptyState.style.display = "block";
                    table.style.display = "none";
                    return;
                }

                // We have data â†’ show table, hide empty state
                emptyState.style.display = "none";
                table.style.display = "table";

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.createdAt?.toDate().toLocaleString() ?? "N/A";
                    const langs = `${data.sourceLang} â†’ ${data.targetLang}`;
                    const file = data.file || "â€”";
                    const status = data.status || "ðŸ•’ Pending";
                    const notes = data.notes || "â€”";

                    const row = document.createElement("tr");
                    row.innerHTML = `
            <td>${date}</td>
            <td>${langs}</td>
            <td>${file}</td>
            <td>${status}</td>
            <td>${notes}</td>
          `;
                    tableBody.appendChild(row);
                });
            } catch (err) {
                // If query fails (e.g., missing index), show graceful empty state
                console.error(err);
                emptyState.textContent = "No active requests.";
                emptyState.style.display = "block";
                table.style.display = "none";
            }
        });
    </script>
</body>

</html>