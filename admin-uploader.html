<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Admin Uploader - Rolling Translations</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        body {
            background: #fff;
        }

        .container {
            max-width: 1100px;
            margin: 32px auto;
            padding: 0 16px;
        }

        .logo {
            height: 56px;
        }

        h1 {
            margin: 12px 0 4px;
        }

        .muted {
            color: #666;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin: 16px 0 8px;
        }

        .toolbar input[type="text"] {
            flex: 1 1 320px;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 12px;
        }

        .right {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background: #fff;
            cursor: pointer;
        }

        .btn.primary {
            background: #4c7cf3;
            color: #fff;
            border-color: #4c7cf3;
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th,
        td {
            border: 1px solid #e7e7e7;
            padding: 10px;
            vertical-align: top;
            word-wrap: break-word;
        }

        th {
            background: #f6f7fb;
            text-align: center;
            font-weight: 700;
        }

        tbody tr:nth-child(even) {
            background: #fafafa;
        }

        tbody tr:hover {
            background: #f1f7ff;
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .chip {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 14px;
            padding: 4px 8px;
            background: #fff;
            font-size: 12px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            background: #eee;
        }

        .badge.pending {
            background: #fff5e6;
        }

        .badge.inprogress,
        .badge.progress {
            background: #eaf2ff;
        }

        .badge.delivered,
        .badge.finalized {
            background: #e9f8ef;
        }

        .badge.rejected {
            background: #ffe9e9;
        }

        .status-select {
            width: 100%;
            padding: 6px 8px;
            border-radius: 10px;
            border: 1px solid #ddd;
            background: #fff;
        }

        .upload-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .small {
            font-size: 12px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        .center {
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <img src="images/logo.png" alt="Rolling Translations Logo" class="logo" />
        <h1>Admin – Project Requests</h1>
        <p class="muted">Manage requests, upload deliverables, and update status.</p>

        <div id="gate" class="muted">Checking admin access…</div>

        <div class="toolbar hidden" id="toolbar">
            <input id="search" type="text" placeholder="Search by client name, email, projectId, notes…" />
            <div class="right">
                <button id="refreshBtn" class="btn">Refresh</button>
                <button id="logoutBtn" class="btn">Log out</button>
            </div>
        </div>

        <table id="reqTable" class="hidden">
            <thead>
                <tr>
                    <th style="width:140px;">Date</th>
                    <th style="width:160px;">Client</th>
                    <th style="width:160px;">Project ID</th>
                    <th style="width:160px;">Languages</th>
                    <th>Source files</th>
                    <th style="width:150px;">Status</th>
                    <th>Deliverables</th>
                    <th style="width:230px;">Upload</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <p id="emptyState" class="muted center hidden">No requests found.</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
        import {
            getFirestore, collection, getDocs, query, orderBy, updateDoc, doc, getDoc,
            arrayUnion
        } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-storage.js";

        // --- Firebase config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBYjq_CaTEfFhfTChfJ6SnXSbgIzbbRHHc",
            authDomain: "rollingtranslationsportal.firebaseapp.com",
            projectId: "rollingtranslationsportal",
            storageBucket: "rollingtranslationsportal.firebasestorage.app",
            messagingSenderId: "492156326175",
            appId: "1:492156326175:web:14175badae2bbaada0e02a"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const gate = document.getElementById("gate");
        const toolbar = document.getElementById("toolbar");
        const table = document.getElementById("reqTable");
        const tbody = table.querySelector("tbody");
        const emptyState = document.getElementById("emptyState");
        const searchInput = document.getElementById("search");

        const logoutBtn = document.getElementById("logoutBtn");
        logoutBtn.addEventListener("click", () => signOut(auth).then(() => location.href = "index.html"));

        document.getElementById("refreshBtn").addEventListener("click", loadData);
        searchInput.addEventListener("input", () => renderRows(window.__allRows || []));

        const STATUS_OPTIONS = ["Pending", "In progress", "Delivered", "Finalized", "Rejected"];

        // ---------- Admin gate via Firestore users/{uid}.role ----------
        onAuthStateChanged(auth, async (user) => {
            if (!user) { location.href = "index.html"; return; }
            gate.textContent = "Checking admin access…";

            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                const role = userDoc.exists() ? userDoc.data().role : null;

                if (role !== "admin") {
                    gate.textContent = "Access denied. Admin only.";
                    alert("This page is for admins only.");
                    location.href = "index.html";
                    return;
                }
                // OK admin
                gate.classList.add("hidden");
                toolbar.classList.remove("hidden");
                table.classList.remove("hidden");
                await loadData();
            } catch (err) {
                console.error("Admin gate error:", err);
                gate.textContent = "Error checking admin.";
            }
        });

        // ---------- Load & Render ----------
        async function loadData() {
            const q = query(collection(db, "projectRequests"), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);

            const rows = [];
            snap.forEach(d => {
                const data = d.data();
                rows.push({
                    id: d.id,
                    createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : null,
                    fullname: data.fullname || "",
                    email: data.email || "",
                    sourceLang: data.sourceLang || "",
                    targetLang: data.targetLang || "",
                    files: Array.isArray(data.files) ? data.files : (data.file ? [data.file] : []),
                    notes: data.notes || "",
                    status: data.status || "Pending",
                    deliverables: Array.isArray(data.deliverables) ? data.deliverables : [],
                    projectId: data.projectId || "" // tu custom projectId (distinto del docId)
                });
            });

            window.__allRows = rows;
            renderRows(rows);
        }

        function renderRows(rows) {
            const q = searchInput.value.trim().toLowerCase();
            const filtered = rows.filter(r => {
                if (!q) return true;
                return [r.fullname, r.email, r.projectId, r.status, r.sourceLang, r.targetLang, r.files.join(", "), r.notes]
                    .join(" | ").toLowerCase().includes(q);
            });

            tbody.innerHTML = "";
            if (!filtered.length) {
                emptyState.classList.remove("hidden");
                return;
            }
            emptyState.classList.add("hidden");

            for (const r of filtered) {
                const tr = document.createElement("tr");

                const dateText = r.createdAt ? r.createdAt.toLocaleString() : "N/A";
                const langs = `${r.sourceLang} → ${r.targetLang}`;

                const filesHtml = r.files.length
                    ? `<div class="chips">${r.files.map(f => `<span class="chip">${el(f)}</span>`).join("")}</div>`
                    : "—";

                const statusSel = `
        <select class="status-select" data-docid="${r.id}">
        ${STATUS_OPTIONS.map(s => `<option value="${s}" ${s === r.status ? 'selected' : ''}>${s}</option>`).join("")}
        </select>
        <div class="small">docId: <code>${r.id}</code></div>
    `;

                const delivHtml = r.deliverables?.length
                    ? `<div class="chips">${r.deliverables.map((d, i) => {
                        const name = (d.name || `File ${i + 1}`);
                        const title = d.path || name;
                        const link = d.url ? d.url : null;
                        return link
                            ? `<a class="chip" href="${link}" target="_blank" rel="noopener" title="${el(title)}">${el(name)} ⬇️</a>`
                            : `<span class="chip" title="${el(title)}">${el(name)} (no URL)</span>`;
                    }).join("")}</div>`
                    : "—";

                const uploadId = `up_${r.id}`;
                const upHtml = `
        <div class="upload-wrap">
        <input type="file" id="${uploadId}" multiple />
        <button class="btn primary" data-docid="${r.id}" data-input="${uploadId}">Upload</button>
        </div>
        <div class="small">Uploads go to <code>deliverables/${r.id}/</code></div>
    `;

                tr.innerHTML = `
        <td>${dateText}</td>
        <td>
        <div><strong>${el(r.fullname) || "—"}</strong></div>
        <div class="small">${el(r.email) || "—"}</div>
        </td>
        <td>${el(r.projectId) || "—"}</td>
        <td>${el(langs)}</td>
        <td>${filesHtml}</td>
        <td>${statusSel}</td>
        <td>${delivHtml}</td>
        <td>${upHtml}</td>
    `;
                tbody.appendChild(tr);
            }

            // events
            tbody.querySelectorAll("select.status-select").forEach(sel => {
                sel.addEventListener("change", onStatusChange);
            });
            tbody.querySelectorAll("button.btn.primary").forEach(btn => {
                btn.addEventListener("click", onUploadClick);
            });
        }

        // ---------- Handlers ----------
        async function onStatusChange(e) {
            const sel = e.currentTarget;
            const docId = sel.dataset.docid;
            const value = sel.value;
            sel.disabled = true;
            try {
                await updateDoc(doc(db, "projectRequests", docId), { status: value });
                sel.style.borderColor = "#4c7cf3";
                setTimeout(() => sel.style.borderColor = "#ddd", 800);
            } catch (err) {
                console.error("Status update failed", err);
                alert("Failed to update status: " + err.message);
            } finally {
                sel.disabled = false;
            }
        }

        async function onUploadClick(e) {
            const btn = e.currentTarget;
            const docId = btn.dataset.docid;
            const inputId = btn.dataset.input;
            const input = document.getElementById(inputId);
            const files = Array.from(input.files || []);
            if (!files.length) { alert("Select one or more files first."); return; }

            btn.disabled = true; btn.textContent = "Uploading…";

            try {
                const updates = [];
                for (const f of files) {
                    const path = `deliverables/${docId}/${Date.now()}_${f.name}`;
                    const fileRef = ref(storage, path);
                    await uploadBytes(fileRef, f);
                    const url = await getDownloadURL(fileRef);

                    updates.push({
                        name: f.name,
                        path,
                        url,
                        uploadedAt: new Date()
                    });
                }
                await updateDoc(doc(db, "projectRequests", docId), {
                    deliverables: arrayUnion(...updates),
                    status: "Delivered" // opcional: marcamos entregado al subir
                });

                input.value = "";
                await loadData();
            } catch (err) {
                console.error("Upload failed", err);
                alert("Failed to upload: " + err.message);
            } finally {
                btn.disabled = false; btn.textContent = "Upload";
            }
        }

        // ---------- Utils ----------
        function el(txt) {
            return String(txt ?? "").replace(/[&<>"'`=\/]/g, s => ({
                "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;", "/": "&#x2F;", "`": "&#x60;", "=": "&#x3D;"
            }[s]));
        }
    </script>
</body>

</html>