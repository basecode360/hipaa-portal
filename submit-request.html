<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rolling Translations Client Portal</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        /* ---- Files UI ---- */
        .dropzone {
            border: 2px dashed #9bb4ff;
            border-radius: 10px;
            padding: 18px;
            text-align: center;
            background: #f7faff;
            color: #355cf0;
            cursor: pointer;
            margin: 10px 0 16px 0;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .dropzone.dragover {
            background: #eef5ff;
            border-color: #355cf0;
        }

        .files-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .file-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #eef2ff;
            color: #1e293b;
            border: 1px solid #c7d2fe;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 14px;
        }

        .file-chip .remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 14px;
            padding: 2px 8px;
            cursor: pointer;
        }

        .hint {
            color: #64748b;
            font-size: 12px;
            margin-top: 8px;
        }

        .left-aligned {
            text-align: left;
        }

        .languages-box {
            width: 100%;
            height: 140px;
        }

        .rush-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0 16px;
        }

        .rush-label {
            font-weight: 600;
            line-height: 1.2;
            margin: 0;
        }

        #requestsTable tbody tr.rush {
            background: #fff1f2;
            /* light red */
        }
    </style>
</head>

<body>
    <div class="container">
        <img src="images/logo.png" alt="Rolling Translations Logo" class="logo" />
        <h1>Submit Translation Request</h1>
        <p class="description">
            Use this secure form to upload documents for translation. Rolling Translations provides HIPAA-compliant
            services with fast turnaround times, including 24/7 support for urgent medical content.
        </p>

        <form id="projectRequestForm">
            <label for="sourceLang">Source Language (*)</label>
            <p class="instruction">To select multiple languages, hold your ctrl (Control) key while selecting all
                languages.</p>
            <select class="languages-box" id="sourceLang" name="sourceLang" multiple required>
                <option value="">-- Select --</option>
                <option value="sq">Albanian</option>
                <option value="ar">Arabic</option>
                <option value="hy">Armenian</option>
                <option value="bn">Bengali</option>
                <option value="bs">Bosnian</option>
                <option value="bg">Bulgarian</option>
                <option value="my">Burmese</option>
                <option value="km">Cambodian</option>
                <option value="zh">Chinese</option>
                <option value="hr">Croatian</option>
                <option value="fa">Farsi</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="el">Greek</option>
                <option value="he">Hebrew</option>
                <option value="hi">Hindi</option>
                <option value="it">Italian</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="lo">Lao</option>
                <option value="pt">Portuguese</option>
                <option value="pa">Punjabi</option>
                <option value="ro">Romanian</option>
                <option value="ru">Russian</option>
                <option value="szh">Simplified Chinese</option>
                <option value="es">Spanish</option>
                <option value="sw">Swahili</option>
                <option value="sv">Swedish</option>
                <option value="tl">Tagalog</option>
                <option value="th">Thai</option>
                <option value="tzh">Traditional Chinese</option>
                <option value="tr">Turkish</option>
                <option value="ur">Urdu</option>
                <option value="vi">Vietnamese</option>
            </select>

            <label for="targetLang">Target Language(s) (*)</label>
            <p class="instruction">To select multiple languages, hold your ctrl (Control) key while selecting all
                languages.</p>
            <select class="languages-box" id="targetLang" name="targetLang" multiple required>
                <option value="">-- Select --</option>
                <option value="sq">Albanian</option>
                <option value="ar">Arabic</option>
                <option value="hy">Armenian</option>
                <option value="bn">Bengali</option>
                <option value="bs">Bosnian</option>
                <option value="bg">Bulgarian</option>
                <option value="my">Burmese</option>
                <option value="km">Cambodian</option>
                <option value="zh">Chinese</option>
                <option value="hr">Croatian</option>
                <option value="ca">Catalan</option>
                <option value="cs">Czech</option>
                <option value="dr">Dari</option>
                <option value="nl">Dutch</option>
                <option value="en">English</option>
                <option value="fa">Farsi</option>
                <option value="fi">Finnish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="el">Greek</option>
                <option value="he">Hebrew</option>
                <option value="hi">Hindi</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="lo">Lao</option>
                <option value="pt">Portuguese</option>
                <option value="pa">Punjabi</option>
                <option value="ro">Romanian</option>
                <option value="ru">Russian</option>
                <option value="szh">Simplified Chinese</option>
                <option value="es">Spanish</option>
                <option value="sw">Swahili</option>
                <option value="sv">Swedish</option>
                <option value="tl">Tagalog</option>
                <option value="th">Thai</option>
                <option value="tzh">Traditional Chinese</option>
                <option value="tr">Turkish</option>
                <option value="ur">Urdu</option>
                <option value="vi">Vietnamese</option>
            </select>

            <!-- Files -->
            <label>Files (*)</label>
            <div id="dropzone" class="dropzone">
                <strong>Drag & drop</strong> files here or <u>click to select</u>.
                <div class="hint">You can add files from different folders. They will appear below.</div>
                <input type="file" id="file" name="file" multiple style="display:none;" />
            </div>
            <!-- Selected files list -->
            <div id="filesList" class="files-list"></div>

            <!-- Rush -->
            <div class="rush-row">
                <input type="checkbox" id="rush" name="rush" />
                <label for="rush" class="rush-label">Rush (expedite this project)</label>
            </div>

            <label for="notes">Additional Notes</label>
            <textarea id="notes" name="notes" rows="4"></textarea>

            <p class="left-aligned">(*) Required fields.</p>

            <button type="submit">Send Request</button>
        </form>

        <p id="confirmationMsg" style="display:none; color:green;">✅ Project request sent!</p>

        <button type="button" id="backToDashboardBtn">Back to Dashboard</button>
        <script>
            document.getElementById('backToDashboardBtn').addEventListener('click', () => {
                window.location.href = 'dashboard.html';
            });
        </script>

        <!-- Hidden form to send to Google Apps Script (Spreadsheet) -->
        <form id="spreadsheetForm" method="POST"
            action="https://script.google.com/macros/s/AKfycbz1f_Z6QerMzIm2m3jwdfiCq9H0aWz0vQ0B7H6Wuhs1Qx2i4jQEMgqVdW03C3Jz2gI/exec"
            style="display:none;">
            <input type="hidden" name="fullname" id="fullnameField" />
            <input type="hidden" name="email" id="emailField" />
            <input type="hidden" name="phone" id="phoneField" />
            <input type="hidden" name="sourceLang" id="sourceLangField" />
            <input type="hidden" name="targetLang" id="targetLangField" />
            <input type="hidden" name="notes" id="notesField" />
            <input type="hidden" name="fileName" id="fileNameField" />
            <input type="hidden" name="projectId" id="projectIdField" />
            <input type="hidden" name="rush" id="rushField" />
        </form>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import {
            getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, updateDoc
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import {
            getStorage, ref, uploadBytes
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // ---- Firebase Config ----
        const firebaseConfig = {
            apiKey: "AIzaSyBYjq_CaTEfFhfTChfJ6SnXSbgIzbbRHHc",
            authDomain: "rollingtranslationsportal.firebaseapp.com",
            projectId: "rollingtranslationsportal",
            storageBucket: "rollingtranslationsportal.firebasestorage.app",
            messagingSenderId: "492156326175",
            appId: "1:492156326175:web:14175badae2bbaada0e02a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const form = document.getElementById("projectRequestForm");

        // --------- Auth gate + load profile ---------
        let clientFullName = "";
        let clientOrg = "";
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }
            // Try to read user profile
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                const userData = userSnap.data();
                clientFullName = userData.fullName;
                clientOrg = userData.org;
            }
        });

        // Logout
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
            logoutBtn.addEventListener("click", () => {
                signOut(auth).then(() => {
                    window.location.href = "index.html";
                });
            });
        }

        // Utilities
        function getSelectedValues(selectEl) {
            return Array.from(selectEl.selectedOptions).map(o => o.value).filter(Boolean);
        }
        function buildProjectId({ sourceLang, targetLang, firstFileName, date }) {
            const lettersOnly = firstFileName.replace(/[^A-Za-z]/g, "").slice(0, 5).toUpperCase();
            const MM = String(date.getMonth() + 1).padStart(2, "0");
            const DD = String(date.getDate()).padStart(2, "0");
            const YY = String(date.getFullYear()).slice(-2);
            const HH = String(date.getHours()).padStart(2, "0");
            const mm = String(date.getMinutes()).padStart(2, "0");
            const src = (Array.isArray(sourceLang) ? sourceLang.join("") : sourceLang || "").replace(/[^A-Za-z]/g, "");
            const tgt = (Array.isArray(targetLang) ? targetLang.join("") : targetLang || "").replace(/[^A-Za-z]/g, "");
            return `${src}${tgt}${lettersOnly}${MM}${DD}${YY}${HH}${mm}`;
        }

        // ---------- Multiple files handling ----------
        const dropzone = document.getElementById("dropzone");
        const fileInput = document.getElementById("file");
        const filesListEl = document.getElementById("filesList");
        let selectedFiles = []; // array of File

        function filesAreSame(a, b) {
            return a.name === b.name && a.size === b.size && a.lastModified === b.lastModified;
        }
        function addFiles(files) {
            for (const f of files) {
                if (!selectedFiles.some(sf => filesAreSame(sf, f))) {
                    selectedFiles.push(f);
                }
            }
            renderFiles();
        }
        function removeFileAt(index) {
            selectedFiles.splice(index, 1);
            renderFiles();
        }
        function renderFiles() {
            filesListEl.innerHTML = "";
            if (!selectedFiles.length) return;
            selectedFiles.forEach((f, idx) => {
                const chip = document.createElement("div");
                chip.className = "file-chip";
                chip.innerHTML = `
                    <span>${f.name}</span>
                    <button type="button" class="remove" aria-label="Remove file">x</button>
                `;
                chip.querySelector(".remove").addEventListener("click", () => removeFileAt(idx));
                filesListEl.appendChild(chip);
            });
        }

        dropzone.addEventListener("click", () => fileInput.click());
        dropzone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropzone.classList.add("dragover");
        });
        dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
        dropzone.addEventListener("drop", (e) => {
            e.preventDefault();
            dropzone.classList.remove("dragover");
            const files = Array.from(e.dataTransfer.files || []);
            addFiles(files);
        });
        fileInput.addEventListener("change", () => {
            const files = Array.from(fileInput.files || []);
            addFiles(files);
            fileInput.value = "";
        });

        // Submit
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const sourceLangSelect = document.getElementById("sourceLang");
            const targetLangSelect = document.getElementById("targetLang");
            const notes = document.getElementById("notes").value;
            const rush = document.getElementById("rush").checked;

            const sourceLang = getSelectedValues(sourceLangSelect);
            const targetLang = getSelectedValues(targetLangSelect);

            if (!selectedFiles.length) {
                alert("Please attach at least one file.");
                return;
            }

            try {
                // --- Current user info ---
                const user = auth.currentUser;
                const userEmail = user?.email || "";
                const fullName = clientFullName || user?.displayName || "";
                const phone = ""; // optional

                // --- Build a human-readable projectId (kept for tracking/spreadsheet) ---
                const projectId = buildProjectId({
                    sourceLang,
                    targetLang,
                    firstFileName: selectedFiles[0].name,
                    date: new Date()
                });

                // --- 1) Create Firestore doc FIRST ---
                const docRef = await addDoc(collection(db, "projectRequests"), {
                    projectId,
                    rush,
                    sourceLang: sourceLang.join(", "),
                    targetLang: targetLang.join(", "),
                    notes,
                    files: [],
                    fullname: fullName,
                    email: userEmail,
                    ownerUid: user?.uid || "",
                    status: "Pending",
                    deliverables: [],
                    createdAt: serverTimestamp()
                });
                // keep a stable id in the document
                await updateDoc(docRef, { docId: docRef.id });

                // --- 2) Upload files to Storage under the docId path ---
                const uploadedNames = [];
                for (const file of selectedFiles) {
                    const storagePath = `projects/${docRef.id}/${Date.now()}_${file.name}`;
                    const fileRef = ref(storage, storagePath);
                    await uploadBytes(fileRef, file);
                    uploadedNames.push(file.name);
                }

                // --- 3) Update doc with uploaded filenames ---
                await updateDoc(docRef, { files: uploadedNames });

                // --- 4) Send to the spreadsheet (Apps Script form POST) ---
                document.getElementById("fullnameField").value = fullName;
                document.getElementById("emailField").value = userEmail;
                document.getElementById("phoneField").value = phone;
                document.getElementById("sourceLangField").value = sourceLang.join(", ");
                document.getElementById("targetLangField").value = targetLang.join(", ");
                document.getElementById("notesField").value = notes;
                document.getElementById("fileNameField").value = uploadedNames.join(", ");
                document.getElementById("projectIdField").value = projectId;
                document.getElementById("rushField").value = rush ? "Yes" : "No";

                document.getElementById("spreadsheetForm").submit();

                // --- 5) Redirect to dashboard ---
                window.location.href = "dashboard.html";
            } catch (error) {
                alert("⚠️ Error: " + error.message);
                console.error(error);
            }
        });
    </script>
</body>

</html>