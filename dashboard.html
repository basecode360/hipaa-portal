<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Requests - Rolling Translations</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="container">
        <img src="images/logo.png" alt="Rolling Translations Logo" class="logo" />
        <h1>Your Translation Requests</h1>

        <!-- Empty state -->
        <p id="emptyState" style="display:none; margin: 16px 0;">No active requests.</p>

        <!-- Table -->
        <table id="requestsTable" style="display:none;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Languages</th>
                    <th>File</th>
                    <th>Status</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

                <!-- Actions -->
        <div style="margin: 12px 0;">
            <button id="newRequestBtn">Submit a new request</button>
        </div>

        <button id="logoutBtn" style="margin-top:16px;">Log out</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYjq_CaTEfFhfTChfJ6SnXSbgIzbbRHHc",
            authDomain: "rollingtranslationsportal.firebaseapp.com",
            projectId: "rollingtranslationsportal",
            storageBucket: "rollingtranslationsportal.firebasestorage.app",
            messagingSenderId: "492156326175",
            appId: "1:492156326175:web:14175badae2bbaada0e02a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const table = document.getElementById("requestsTable");
        const tbody = table.querySelector("tbody");
        const emptyState = document.getElementById("emptyState");

        document.getElementById("newRequestBtn").addEventListener("click", () => {
            window.location.href = "submit-request.html";
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            signOut(auth).then(() => (window.location.href = "index.html"));
        });

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }

            try {
                const q = query(
                    collection(db, "projectRequests"),
                    where("email", "==", user.email)
                );
                const snap = await getDocs(q);

                if (snap.empty) {
                    emptyState.style.display = "block";
                    table.style.display = "none";
                    return;
                }

                // Collect & client-sort by createdAt desc
                const rows = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    rows.push({
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : null,
                        sourceLang: data.sourceLang || "",
                        targetLang: data.targetLang || "",
                        file: data.file || "â€”",
                        status: data.status || "ðŸ•’ Pending",
                        notes: data.notes || "â€”"
                    });
                });

                rows.sort((a, b) => (b.createdAt?.getTime?.() || 0) - (a.createdAt?.getTime?.() || 0));

                tbody.innerHTML = "";
                for (const r of rows) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
        <td>${r.createdAt ? r.createdAt.toLocaleString() : "N/A"}</td>
        <td>${r.sourceLang} â†’ ${r.targetLang}</td>
        <td>${r.file}</td>
        <td>${r.status}</td>
        <td>${r.notes}</td>
        `;
                    tbody.appendChild(tr);
                }

                emptyState.style.display = "none";
                table.style.display = "table";

            } catch (err) {
                console.error("Firestore error:", err);
                emptyState.textContent = "No active requests.";
                emptyState.style.display = "block";
                table.style.display = "none";
            }
        });
    </script>
</body>

</html>