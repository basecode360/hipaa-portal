<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Admin Uploader - Rolling Translations</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="container">
        <img src="images/logo.png" alt="Rolling Translations Logo" class="logo" />
        <h1>Admin – Project Requests</h1>
        <p class="muted">Manage requests, upload deliverables, and update status.</p>

        <div id="gate" class="muted">Checking admin access…</div>

        <div class="toolbar hidden" id="toolbar">
            <input id="search" type="text" placeholder="Search by client name, email, projectId, notes…" />
            <div class="right">
                <button id="refreshBtn" class="btn">Refresh</button>
                <button id="logoutBtn" class="btn">Log out</button>
            </div>
        </div>

        <table id="reqTable" class="hidden">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Project ID</th>
                    <th>Languages</th>
                    <th>Source files</th>
                    <th>Status</th>
                    <th>Deliverables</th>
                    <th>Upload</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <p id="emptyState" class="muted center hidden">No requests found.</p>
    </div>

    <script type="module">
        console.log("[BOOT] Bucket runtime:", getStorage().app.options.storageBucket);

        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

        onAuthStateChanged(getAuth(), async (user) => {
            if (!user) {
                console.warn("[BOOT] No user signed in");
                return;
            }
            console.log("[AUTH] Current UID:", user.uid, "email:", user.email);

            const db = getFirestore();
            const snap = await getDoc(doc(db, "users", user.uid));
            console.log("[FIRESTORE] users/{uid} exists?", snap.exists(), "data:", snap.data());
        });

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
        import {
            getFirestore, collection, getDocs, query, orderBy, updateDoc, doc, getDoc,
            arrayUnion
        } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYjq_CaTEfFhfTChfJ6SnXSbgIzbbRHHc",
            authDomain: "rollingtranslationsportal.firebaseapp.com",
            projectId: "rollingtranslationsportal",
            storageBucket: "rollingtranslationsportal.firebasestorage.app",
            messagingSenderId: "492156326175",
            appId: "1:492156326175:web:14175badae2bbaada0e02a"
        };
        const app = initializeApp(firebaseConfig);
        console.log("[BOOT] Bucket runtime:", getStorage(app).app.options.storageBucket);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const gate = document.getElementById("gate");
        const toolbar = document.getElementById("toolbar");
        const table = document.getElementById("reqTable");
        const tbody = table.querySelector("tbody");
        const emptyState = document.getElementById("emptyState");
        const searchInput = document.getElementById("search");

        document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth).then(() => location.href = "index.html"));
        document.getElementById("refreshBtn").addEventListener("click", loadData);
        searchInput.addEventListener("input", () => renderRows(window.__allRows || []));

        const STATUS_OPTIONS = ["Pending", "In progress", "Delivered", "Finalized", "Rejected"];

        // ---------- Admin gate ----------
        onAuthStateChanged(auth, async (user) => {
            if (!user) { location.href = "index.html"; return; }
            console.log("[AUTH] Logged in user:", user.email, "uid:", user.uid);
            gate.textContent = "Checking admin access…";

            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                console.log("[AUTH] User doc:", userDoc.exists() ? userDoc.data() : "not found");

                const role = userDoc.exists() ? userDoc.data().role : null;
                if (role !== "admin") {
                    gate.textContent = "Access denied. Admin only.";
                    alert("This page is for admins only.");
                    location.href = "index.html";
                    return;
                }

                console.log("[AUTH] Admin access granted ✅");
                gate.classList.add("hidden");
                toolbar.classList.remove("hidden");
                table.classList.remove("hidden");
                await loadData();
            } catch (err) {
                console.error("[AUTH] Admin gate error:", err);
                gate.textContent = "Error checking admin.";
            }
        });

        // ---------- Load & Render ----------
        async function loadData() {
            console.log("[LOAD] Fetching projectRequests…");
            const q = query(collection(db, "projectRequests"), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);

            const rows = [];
            snap.forEach(d => {
                const data = d.data();
                rows.push({
                    id: d.id,
                    createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : null,
                    fullname: data.fullname || "",
                    email: data.email || "",
                    sourceLang: data.sourceLang || "",
                    targetLang: data.targetLang || "",
                    files: Array.isArray(data.files) ? data.files : (data.file ? [data.file] : []),
                    notes: data.notes || "",
                    status: data.status || "Pending",
                    deliverables: Array.isArray(data.deliverables) ? data.deliverables : [],
                    projectId: data.projectId || ""
                });
            });

            console.log("[LOAD] Rows fetched:", rows.length);
            window.__allRows = rows;
            renderRows(rows);
        }

        function renderRows(rows) {
            console.log("[RENDER] Rendering rows:", rows.length);
            tbody.innerHTML = "";
            if (!rows.length) {
                emptyState.classList.remove("hidden");
                return;
            }
            emptyState.classList.add("hidden");

            for (const r of rows) {
                const tr = document.createElement("tr");
                const dateText = r.createdAt ? r.createdAt.toLocaleString() : "N/A";
                const langs = `${r.sourceLang} → ${r.targetLang}`;

                const filesHtml = r.files.length
                    ? `<div>${r.files.map(f => `<span>${f}</span>`).join(", ")}</div>`
                    : "—";

                const statusSel = `
          <select class="status-select" data-docid="${r.id}">
            ${STATUS_OPTIONS.map(s => `<option value="${s}" ${s === r.status ? 'selected' : ''}>${s}</option>`).join("")}
          </select>
        `;

                const delivHtml = r.deliverables?.length
                    ? r.deliverables.map(d => `<a href="${d.url}" target="_blank">${d.name} ⬇️</a>`).join("<br>")
                    : "—";

                const uploadId = `up_${r.id}`;
                const upHtml = `
          <input type="file" id="${uploadId}" multiple />
          <button class="btn primary" data-docid="${r.id}" data-input="${uploadId}">Upload</button>
        `;

                tr.innerHTML = `
          <td>${dateText}</td>
          <td>${r.fullname}<br><small>${r.email}</small></td>
          <td>${r.projectId || "—"}</td>
          <td>${langs}</td>
          <td>${filesHtml}</td>
          <td>${statusSel}</td>
          <td>${delivHtml}</td>
          <td>${upHtml}</td>
        `;
                tbody.appendChild(tr);
            }

            tbody.querySelectorAll("select.status-select").forEach(sel => sel.addEventListener("change", onStatusChange));
            tbody.querySelectorAll("button.btn.primary").forEach(btn => btn.addEventListener("click", onUploadClick));
        }

        // ---------- Handlers ----------
        async function onStatusChange(e) {
            const sel = e.currentTarget;
            const docId = sel.dataset.docid;
            const value = sel.value;
            console.log("[STATUS] Updating doc:", docId, "to:", value);

            try {
                await updateDoc(doc(db, "projectRequests", docId), { status: value });
                console.log("[STATUS] Update OK");
            } catch (err) {
                console.error("[STATUS] Update failed:", err);
                alert("Failed to update status: " + err.message);
            }
        }

        async function onUploadClick(e) {
            const btn = e.currentTarget;
            const docId = btn.dataset.docid;
            const inputId = btn.dataset.input;
            const input = document.getElementById(inputId);
            const files = Array.from(input.files || []);
            if (!files.length) { alert("Select files first."); return; }

            console.log("[UPLOAD] Starting upload for docId:", docId, "files:", files.map(f => f.name));
            btn.disabled = true; btn.textContent = "Uploading…";

            try {
                const updates = [];
                for (const f of files) {
                    const path = `deliverables/${docId}/${Date.now()}_${f.name}`;
                    console.log("[UPLOAD] Path:", path);
                    const fileRef = ref(storage, path);

                    await uploadBytes(fileRef, f);
                    console.log("[UPLOAD] Uploaded:", f.name);

                    const url = await getDownloadURL(fileRef);
                    console.log("[UPLOAD] URL obtained:", url);

                    updates.push({ name: f.name, path, url, uploadedAt: new Date() });
                }
                await updateDoc(doc(db, "projectRequests", docId), {
                    deliverables: arrayUnion(...updates),
                    status: "Delivered"
                });
                console.log("[UPLOAD] Firestore updated for docId:", docId);

                input.value = "";
                await loadData();
            } catch (err) {
                console.error("[UPLOAD] Failed:", err);
                alert("Failed to upload: " + err.message);
            } finally {
                btn.disabled = false; btn.textContent = "Upload";
            }
        }
    </script>
</body>

</html>