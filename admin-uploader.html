<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Admin – Project Requests</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f9fafb;
            margin: 20px;
            color: #111827;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .08);
            padding: 20px;
        }

        .logo {
            width: fit-content;
            height: 60px;
            display: block;
            margin: 0 auto 14px;
        }

        h1 {
            text-align: center;
            margin: 6px 0 4px;
        }

        .subtitle {
            text-align: center;
            color: #6b7280;
            margin: 0 0 18px;
        }

        /* Control bar */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 10px 0 16px;
        }

        .logout-btn {
            background: none;
            border: 1px solid #d1d5db;
            color: #4b5563;
            font-size: 14px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .logout-btn:hover {
            background-color: #f3f4f6;
        }

        .actions-label {
            font-weight: 600;
            color: #1f2937;
            margin-right: 8px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        #requestsTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #requestsTable th,
        #requestsTable td {
            border: 1px solid #d1d5db;
            padding: 12px;
            text-align: left;
            vertical-align: top;
        }

        #requestsTable th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #374151;
            text-align: center;
        }

        #requestsTable tr:nth-child(even) {
            background-color: #f9fafb;
        }

        #requestsTable tr:hover {
            background-color: #f1f7ff;
        }

        .status-pending {
            color: #ca8a04;
            background-color: #fef9e6;
            border: 1px solid #fde68a;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
        }

        .status-delivered {
            color: #15803d;
            background-color: #f0fdf4;
            border: 1px solid #b7e4c7;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
        }

        .status-reopen {
            color: #dc2626;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
        }

        /* Form upload */
        .upload-form {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background-color: #f9fafb;
        }

        .upload-form label {
            font-weight: 600;
        }

        .upload-form input[type="file"] {
            padding: 8px;
            background: #fff;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }

        .upload-btn {
            background-color: #3b82f6;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }

        .upload-btn:hover {
            background-color: #2563eb;
        }

        .upload-btn:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        
        /* New styling for rush requests */
        tr.rush-request {
            background-color: #fffae6 !important;
        }
        tr.rush-request td {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <img src="images/logo.png" alt="Rolling Translations Logo" class="logo">
        <h1>Admin Dashboard</h1>
        <p class="subtitle">Manage project requests from clients.</p>

        <div class="controls">
            <button id="logoutBtn" class="logout-btn">Log out</button>
        </div>

        <div class="table-container">
            <div id="loading" style="text-align: center; margin-top: 20px;">
                <img src="images/loading.gif" alt="Loading..." style="width: 50px;">
                <p>Loading projects...</p>
            </div>
            <table id="requestsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Project ID</th>
                        <th>Client Name</th>
                        <th>Languages</th>
                        <th>Files</th>
                        <th>Notes</th>
                        <th>Rush</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYjq_CaTEfFhfTChfJ6SnXSbgIzbbRHHc",
            authDomain: "rollingtranslationsportal.firebaseapp.com",
            projectId: "rollingtranslationsportal",
            storageBucket: "rollingtranslationsportal.firebasestorage.app",
            messagingSenderId: "492156326175",
            appId: "1:492156326175:web:14175badae2bbaada0e02a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const adminEmails = ["belen_luna_1801@hotmail.com"];

        onAuthStateChanged(auth, async (user) => {
            if (user && adminEmails.includes(user.email)) {
                // User is authenticated and an admin.
                document.body.style.display = "block";
                loadData();
            } else {
                // User is not an admin or not authenticated.
                window.location.href = "index.html";
            }
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            signOut(auth);
        });

        function formatDate(timestamp) {
            const date = timestamp?.toDate ? timestamp.toDate() : new Date();
            return date.toLocaleString();
        }

        function el(txt) {
            return String(txt ?? "").replace(/[&<>\"'`=\/]/g, s => ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                "\"": "&quot;",
                "'": "&#39;",
                "/": "&#x2F;",
                "`": "&#x60;",
                "=": "&#x3D;"
            }[s]));
        }

        function getLangPair(data) {
            const sourceLang = data?.sourceLang?.join(", ") || data?.sourceLang || "—";
            const targetLang = data?.targetLang?.join(", ") || data?.targetLang || "—";
            return `${sourceLang} → ${targetLang}`;
        }

        function niceFiles(fileData) {
            if (Array.isArray(fileData)) {
                return fileData.map(f => f.name || f).join(", ");
            }
            return fileData || "—";
        }

        function statusBadge(status) {
            let className = "";
            switch (status) {
                case "Pending":
                    className = "status-pending";
                    break;
                case "Delivered":
                    className = "status-delivered";
                    break;
                case "Re-open":
                    className = "status-reopen";
                    break;
                default:
                    className = "";
            }
            return `<span class="${className}">${status}</span>`;
        }

        function actionButtons(docId, currentStatus) {
            const uploadBtn = `<button class="upload-btn" onclick="toggleUploadForm('${docId}')">Upload</button>`;
            const deliveredBtn = `<button class="status-btn" onclick="updateStatus('${docId}', 'Delivered')">Mark Delivered</button>`;
            const reopenBtn = `<button class="status-btn" onclick="updateStatus('${docId}', 'Re-open')">Re-open</button>`;

            let buttons = ``;
            if (currentStatus === "Pending" || currentStatus === "Re-open") {
                buttons = `${uploadBtn}<br><br>${deliveredBtn}`;
            } else if (currentStatus === "Delivered") {
                buttons = `${reopenBtn}`;
            }
            return `<div class="actions">${buttons}</div>`;
        }

        const pending = new Map();

        window.toggleUploadForm = (docId) => {
            const form = document.getElementById(`uploadForm-${docId}`);
            if (form) {
                form.style.display = form.style.display === "flex" ? "none" : "flex";
                if (form.style.display === "flex") {
                    const input = form.querySelector('input[type="file"]');
                    input.addEventListener('change', () => renderPendingList(docId, input.files));
                }
            }
        };

        window.renderPendingList = (docId, fileList = new FileList()) => {
            const listContainer = document.getElementById(`pending-list-${docId}`);
            if (listContainer) {
                pending.set(docId, Array.from(fileList));
                listContainer.innerHTML = Array.from(fileList).map(f => `<span>${f.name}</span>`).join("");
            }
        };

        window.uploadFiles = async (docId, btn) => {
            const list = pending.get(docId) || [];
            if (list.length === 0) {
                alert("Please select at least one file to upload.");
                return;
            }

            btn.disabled = true;
            btn.textContent = "Uploading...";

            try {
                const updates = [];
                for (const f of list) {
                    const path = `deliverables/${docId}/${Date.now()}_${f.name}`;
                    const fileRef = ref(storage, path);
                    const metadata = {
                        contentType: f.type || 'application/octet-stream',
                        contentDisposition: `attachment; filename=\"${f.name}\"`
                    };
                    await uploadBytes(fileRef, f, metadata);
                    const url = await getDownloadURL(fileRef);
                    updates.push({ name: f.name, path, url, uploadedAt: new Date() });
                }
                await updateDoc(doc(db, "projectRequests", docId), {
                    deliverables: arrayUnion(...updates),
                    status: "Delivered"
                });
                pending.set(docId, []);
                renderPendingList(docId);
                await loadData();
            } catch (err) {
                console.error("[UPLOAD] Failed:", err);
                alert("Failed to upload: " + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "Upload";
            }
        };

        async function loadData() {
            onSnapshot(collection(db, "projectRequests"), (snapshot) => {
                const tbody = document.getElementById("requestsTable").querySelector("tbody");
                tbody.innerHTML = "";

                if (snapshot.empty) {
                    document.getElementById("loading").textContent = "No project requests found.";
                    return;
                }

                snapshot.docs.forEach((doc) => {
                    const rowData = doc.data();
                    const tr = document.createElement("tr");
                    if (rowData.rush) {
                        tr.classList.add("rush-request");
                    }
                    tr.innerHTML = `
                        <td>${formatDate(rowData.createdAt)}</td>
                        <td>${el(rowData.projectId)}</td>
                        <td>${el(rowData.fullname)}</td>
                        <td>${el(getLangPair(rowData))}</td>
                        <td>${el(niceFiles(rowData.files))}</td>
                        <td>${el(rowData.notes)}</td>
                        <td>${rowData.rush ? "Yes" : "No"}</td>
                        <td>${statusBadge(rowData.status)}</td>
                        <td>${actionButtons(doc.id, rowData.status)}</td>
                    `;
                    tr.insertAdjacentHTML("afterend", `
                        <tr>
                            <td colspan="9">
                                <div class="upload-form" id="uploadForm-${doc.id}">
                                    <label>Upload Final Deliverables:</label>
                                    <input type="file" multiple />
                                    <p id="pending-list-${doc.id}"></p>
                                    <button class="upload-btn" onclick="uploadFiles('${doc.id}', this)">Upload</button>
                                </div>
                            </td>
                        </tr>
                    `);
                    tbody.appendChild(tr);
                });
                document.getElementById("loading").style.display = "none";
                document.getElementById("requestsTable").style.display = "table";
            });
        }
    </script>
</body>

</html>