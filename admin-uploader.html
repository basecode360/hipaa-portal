<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Admin Uploader - Rolling Translations</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        /* —— Layout y tabla ——————————————————————————— */
        body {
            background: #fff;
        }

        .container {
            max-width: 1280px;
            margin: 32px auto;
            padding: 0 16px;
        }

        .logo {
            height: 56px;
        }

        h1 {
            margin: 12px 0 4px;
        }

        .muted {
            color: #666;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin: 16px 0 8px;
        }

        .toolbar input[type="text"] {
            flex: 1 1 420px;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 12px;
        }

        .right {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 10px 14px;
            border: 1px solid #cfd3dc;
            border-radius: 10px;
            background: #fff;
            cursor: pointer;
        }

        .btn.primary {
            background: #2f66ff;
            color: #fff;
            border-color: #2f66ff;
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        .table-wrap {
            margin-top: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
            table-layout: fixed;
        }

        th,
        td {
            border: 1px solid #e7e7e7;
            padding: 10px 12px;
            vertical-align: top;
            word-wrap: break-word;
        }

        th {
            background: #f6f7fb;
            text-align: center;
            font-weight: 700;
        }

        /* Anchos de columnas (coinciden con el thead) */
        th.col-date,
        td.col-date {
            width: 160px;
        }

        th.col-client,
        td.col-client {
            width: 200px;
        }

        th.col-project,
        td.col-project {
            width: 180px;
        }

        th.col-langs,
        td.col-langs {
            width: 180px;
        }

        th.col-sources,
        td.col-sources {
            width: 200px;
        }

        th.col-status,
        td.col-status {
            width: 150px;
        }

        th.col-deliver,
        td.col-deliver {
            width: 220px;
        }

        th.col-upload,
        td.col-upload {
            width: 260px;
        }

        tbody tr:nth-child(even) {
            background: #fafafa;
        }

        tbody tr:hover {
            background: #f1f7ff;
        }

        .small {
            font-size: 12px;
            color: #666;
        }

        .center {
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .chip {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 14px;
            padding: 4px 8px;
            background: #fff;
            font-size: 12px;
        }

        .status-select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #ddd;
            background: #fff;
        }

        .upload-wrap {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .upload-wrap input[type="file"] {
            max-width: 220px;
        }
    </style>
</head>

<body>
    <div class="container">
        <img src="images/logo.png" alt="Rolling Translations Logo" class="logo" />
        <h1>Admin – Project Requests</h1>
        <p class="muted">Manage requests, upload deliverables, and update status.</p>

        <div id="gate" class="muted">Checking admin access…</div>

        <div class="toolbar hidden" id="toolbar">
            <input id="search" type="text" placeholder="Search by client name, email, projectId, notes…" />
            <div class="right">
                <button id="refreshBtn" class="btn">Refresh</button>
                <button id="logoutBtn" class="btn">Log out</button>
            </div>
        </div>

        <div class="table-wrap">
            <table id="reqTable" class="hidden">
                <thead>
                    <tr>
                        <th class="col-date">Date</th>
                        <th class="col-client">Client</th>
                        <th class="col-project">Project ID</th>
                        <th class="col-langs">Languages</th>
                        <th class="col-sources">Source files</th>
                        <th class="col-status">Status</th>
                        <th class="col-deliver">Deliverables</th>
                        <th class="col-upload">Upload</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <p id="emptyState" class="muted center hidden">No requests found.</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
        import {
            getFirestore, collection, getDocs, query, orderBy, updateDoc, doc, getDoc, arrayUnion
        } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-storage.js";

        /* Firebase */
        const firebaseConfig = {
            apiKey: "AIzaSyBYjq_CaTEfFhfTChfJ6SnXSbgIzbbRHHc",
            authDomain: "rollingtranslationsportal.firebaseapp.com",
            projectId: "rollingtranslationsportal",
            storageBucket: "rollingtranslationsportal.firebasestorage.app",
            messagingSenderId: "492156326175",
            appId: "1:492156326175:web:14175badae2bbaada0e02a"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        console.log("[BOOT] Bucket runtime:", storage.app.options.storageBucket);

        /* DOM */
        const gate = document.getElementById("gate");
        const toolbar = document.getElementById("toolbar");
        const table = document.getElementById("reqTable");
        const tbody = table.querySelector("tbody");
        const emptyState = document.getElementById("emptyState");
        const searchInput = document.getElementById("search");

        document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth).then(() => location.href = "index.html"));
        document.getElementById("refreshBtn").addEventListener("click", loadData);
        searchInput.addEventListener("input", () => renderRows(window.__allRows || []));

        const STATUS_OPTIONS = ["Pending", "In progress", "Delivered", "Finalized", "Rejected"];

        /* Gate admin (users/{uid}.role === 'admin') */
        onAuthStateChanged(auth, async (user) => {
            if (!user) { location.href = "index.html"; return; }
            console.log("[AUTH] Logged in user:", user.email, "uid:", user.uid);
            gate.textContent = "Checking admin access…";

            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                console.log("[AUTH] User doc:", userDoc.exists() ? userDoc.data() : "not found");
                if (!userDoc.exists() || userDoc.data().role !== "admin") {
                    gate.textContent = "Access denied. Admin only.";
                    alert("This page is for admins only.");
                    location.href = "index.html";
                    return;
                }
                console.log("[AUTH] Admin access granted ✅");
                gate.classList.add("hidden");
                toolbar.classList.remove("hidden");
                table.classList.remove("hidden");
                await loadData();
            } catch (err) {
                console.error("[AUTH] Admin gate error:", err);
                gate.textContent = "Error checking admin.";
            }
        });

        /* Carga + Render */
        async function loadData() {
            console.log("[LOAD] Fetching projectRequests…");
            const q = query(collection(db, "projectRequests"), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);

            const rows = [];
            snap.forEach(d => {
                const data = d.data();
                rows.push({
                    id: d.id,
                    createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : null,
                    fullname: data.fullname || "",
                    email: data.email || "",
                    sourceLang: data.sourceLang || "",
                    targetLang: data.targetLang || "",
                    files: Array.isArray(data.files) ? data.files : (data.file ? [data.file] : []),
                    notes: data.notes || "",
                    status: data.status || "Pending",
                    deliverables: Array.isArray(data.deliverables) ? data.deliverables : [],
                    projectId: data.projectId || ""
                });
            });

            console.log("[LOAD] Rows fetched:", rows.length);
            window.__allRows = rows;
            renderRows(rows);
        }

        function renderRows(rows) {
            console.log("[RENDER] Rendering rows:", rows.length);
            tbody.innerHTML = "";
            if (!rows.length) {
                emptyState.classList.remove("hidden");
                return;
            }
            emptyState.classList.add("hidden");

            const q = (searchInput.value || "").trim().toLowerCase();
            const filtered = rows.filter(r => {
                if (!q) return true;
                return [r.fullname, r.email, r.projectId, r.status, r.sourceLang, r.targetLang, r.files.join(", "), r.notes]
                    .join(" | ").toLowerCase().includes(q);
            });

            for (const r of filtered) {
                const tr = document.createElement("tr");

                const dateText = r.createdAt ? r.createdAt.toLocaleString() : "N/A";
                const langs = `${r.sourceLang} → ${r.targetLang}`;

                const filesHtml = r.files.length
                    ? `<div class="chips">${r.files.map(f => `<span class="chip">${el(f)}</span>`).join("")}</div>`
                    : "—";

                const statusSel = `
          <select class="status-select" data-docid="${r.id}">
            ${STATUS_OPTIONS.map(s => `<option value="${s}" ${s === r.status ? 'selected' : ''}>${s}</option>`).join("")}
          </select>
          <div class="small">docId: <code>${el(r.id)}</code></div>
        `;

                const delivHtml = r.deliverables?.length
                    ? `<div class="chips">${r.deliverables.map((d, i) => {
                        const name = d.name || `File ${i + 1}`;
                        const url = d.url || "";
                        return url
                            ? `<a class="chip" href="${url}" target="_blank" rel="noopener" download>${el(name)} ⬇️</a>`
                            : `<span class="chip">${el(name)} (no URL)</span>`;
                    }).join("")}</div>`
                    : "—";

                const uploadId = `up_${r.id}`;
                const upHtml = `
          <div class="upload-wrap">
            <input type="file" id="${uploadId}" multiple />
            <button class="btn primary" data-docid="${r.id}" data-input="${uploadId}">Upload</button>
          </div>
        `;

                tr.innerHTML = `
          <td class="col-date">${dateText}</td>
          <td class="col-client">
            <strong>${el(r.fullname) || "—"}</strong><br>
            <span class="small">${el(r.email) || "—"}</span>
          </td>
          <td class="col-project">${el(r.projectId) || "—"}</td>
          <td class="col-langs">${el(langs)}</td>
          <td class="col-sources">${filesHtml}</td>
          <td class="col-status">${statusSel}</td>
          <td class="col-deliver">${delivHtml}</td>
          <td class="col-upload">${upHtml}</td>
        `;
                tbody.appendChild(tr);
            }

            tbody.querySelectorAll("select.status-select").forEach(sel => sel.addEventListener("change", onStatusChange));
            tbody.querySelectorAll("button.btn.primary").forEach(btn => btn.addEventListener("click", onUploadClick));
        }

        /* Handlers */
        async function onStatusChange(e) {
            const sel = e.currentTarget;
            const docId = sel.dataset.docid;
            const value = sel.value;
            console.log("[STATUS] Updating doc:", docId, "to:", value);
            try {
                await updateDoc(doc(db, "projectRequests", docId), { status: value });
                console.log("[STATUS] Update OK");
            } catch (err) {
                console.error("[STATUS] Update failed:", err);
                alert("Failed to update status: " + err.message);
            }
        }

        async function onUploadClick(e) {
            const btn = e.currentTarget;
            const docId = btn.dataset.docid;
            const inputId = btn.dataset.input;
            const input = document.getElementById(inputId);
            const files = Array.from(input.files || []);
            if (!files.length) { alert("Select files first."); return; }

            console.log("[UPLOAD] Starting upload for docId:", docId, "files:", files.map(f => f.name));
            btn.disabled = true; btn.textContent = "Uploading…";

            try {
                const updates = [];
                for (const f of files) {
                    const path = `deliverables/${docId}/${Date.now()}_${f.name}`;
                    console.log("[UPLOAD] Path:", path);
                    const fileRef = ref(storage, path);

                    // Fuerza descarga directa
                    const metadata = {
                        contentType: f.type || 'application/octet-stream',
                        contentDisposition: `attachment; filename="${f.name}"`
                    };
                    await uploadBytes(fileRef, f, metadata);
                    const url = await getDownloadURL(fileRef);
                    console.log("[UPLOAD] Uploaded:", f.name, "URL:", url);

                    updates.push({ name: f.name, path, url, uploadedAt: new Date() });
                }
                await updateDoc(doc(db, "projectRequests", docId), {
                    deliverables: arrayUnion(...updates),
                    status: "Delivered"
                });
                console.log("[UPLOAD] Firestore updated for docId:", docId);

                input.value = "";
                await loadData();
            } catch (err) {
                console.error("[UPLOAD] Failed:", err);
                alert("Failed to upload: " + err.message);
            } finally {
                btn.disabled = false; btn.textContent = "Upload";
            }
        }

        /* Utils */
        function el(txt) {
            return String(txt ?? "").replace(/[&<>"'`=\/]/g, s => ({
                "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;", "/": "&#x2F;", "`": "&#x60;", "=": "&#x3D;"
            }[s]));
        }
    </script>
</body>

</html>